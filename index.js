addEventListener("fetch", (event) => {
  event.respondWith(
    handleRequest(event.request).catch(
      (err) => new Response(err.stack, { status: 500 })
    )
  );
});

async function handleRequest(request) {
  const { origin, pathname } = new URL(request.url);

  if (pathname == "/" || pathname == "/txt/" || pathname == "/txt/index.html") {
    return Response.redirect(origin + "/txt/hutrua.txt", 301);
  }

  if (pathname.startsWith("/txt/") && pathname.endsWith(".txt")) {
    let name = pathname.substr(5);
    return handleTxt(name);
  }

  return handleTxt('404.txt');
}

function html_template(page) {
  return `<!DOCTYPE html>
<html>
<head>
  <title>${page.title}</title>
</head>
<body>
  <h1>${page.title}</h1>
  <p>${page.body ? page.body : ''}</p>
  <p style='color:grey;font-size:0.7em;'>This page is generated by Cloudflare Workers.</p>
</body>
</html>`;
}

async function handleTxt(name) {
  let content = await TXT.get(name);
  if (content == null) {
      name = '404.txt';
      content = await TXT.get(name);
  }
  let page = {title: name, body: content};
  return new Response(html_template(page), {
    headers: {"content-type": "text/html;charset=UTF-8",}
  });
}
